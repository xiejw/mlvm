\font\secfont=cmss10
\def\section #1{\vskip0.5\baselineskip\noindent{}{\secfont #1}\vskip\baselineskip}
\def\loss{\hbox{\rm Loss}}
\def\dv{{\rm d}}
% {{{3 Defines a \symbol macro for coding related nouns
%
% * It starts with a group and redfines the undercore (_) to be normal char
% * As all arguments are read when process macro. The macro should be defined as
%   two macros, so the underscore in the argument can be handled correctly.
% * \relax makes the \catcode effective immediately. A {} (empty group) or empty
%   space can work also. This is the space-after-number rule (See TexBook Page
%   208).
% * In the second macro, we use the OPmac local color to change the group as
%   green color.
\font\ninett=cmtt9
\def\symbol{\begingroup\catcode`\_=12\relax\symbolimpl}
\def\symbolimpl#1{{\ninett #1}\endgroup}

% {{{1 Section Problem
\section{Problem}

Given predictions ${\bf p} = [p_1, p_2, \ldots, p_n]$ and targets
${\bf y} = [y_1, y_2, \ldots, y_n]$, the cross entropy loss is defined as
%
$$
    \loss = - \sum_{i} y_i \log p_i,
$$
with gradient:
%
$$
    {\dv \loss \over \dv p_i} = - {\dv y_i \log p_i \over \dv p_i} = - {y_i \over p_i }.
$$

However, this gradient is not numerical stable, as for any super small $p_i$,
i.e., $p_i \to 0$, the gradient is \symbol{NaN}.

% {{{1 Section Solution
\section{Solution}

A common trick to solve this is calculating the gradient from loss $\loss$ w.r.t.
the logits $o_i$  directly, where
%
$$
    p_i = {\exp^{o_i} \over \sum_k \exp^{o_k}}.
$$

The gradient, w.r.t. logits, is
%
$$
    {\dv \loss \over \dv o_i} =
         - \sum_k {\dv \loss \over \dv p_k} {\dv p_k \over \dv o_i}.
$$
where
%
$$
    {\dv \loss \over \dv p_k} = - {y_k \over p_k},
$$
and
%
$$
    {\dv p_k \over \dv o_i} =
        \cases { p_i (1-p_i), & if $k=i$; \cr
                 -p_k p_i & if $k\neq i$. \cr }
$$

Substituting everything into the loss gradient, we get
%
$$
    \eqalign{{\dv \loss \over \dv o_i}
        & = (\dots) \cr
        & = \left( p_i \sum_k { y_k} \right) - y_i \cr
        & = p_i - y_i \cr
    }
$$
where $\sum_k { y_k} = 1$ given ${\bf y}$ is target probability.

\vfill
\bye
